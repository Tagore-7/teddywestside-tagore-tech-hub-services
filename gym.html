<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gym Availability @ Tech</title>
  <meta name="description" content="Gym availability tracker for students at Michigan Tech." />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="wrap">
    <div class="brand">
      <div class="logo" aria-hidden="true">GY</div>
      <div>
        <h1>Gym Availability @ Tech</h1>
        <p class="sub">Working-first version: start/end session stored on your device.</p>
      </div>
    </div>

    <p style="margin-top:0;">
      <a href="./" style="color: rgba(233,233,238,0.85); text-decoration: none; border: 1px solid #2a2f3a; padding: 8px 12px; border-radius: 999px; display:inline-block;">
        ‚Üê Back to hub
      </a>
    </p>
  </header>

  <main class="wrap">
    <section class="card" style="margin-bottom:14px;">
      <h2 style="margin-top:0;">My Gym Session</h2>
      <p class="sub" style="margin-top:0;">
        Saved locally in your browser (your device only). No login, no cloud.
      </p>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <button id="startBtn" type="button" class="btn">Start session</button>
        <button id="endBtn" type="button" class="btn">End session</button>
        <button id="clearBtn" type="button" class="btn btn-ghost">Clear local data</button>
      </div>

      <div class="note" style="margin-top:14px;">
        <p id="status" style="margin:0;">Status: loading‚Ä¶</p>
        <p id="lastSession" style="margin:8px 0 0; color: rgba(233,233,238,0.75);"></p>
        <p id="debug" style="margin:8px 0 0; color: rgba(233,233,238,0.6); font-size: 12px;"></p>
      </div>
    </section>
    <section class="card" style="margin-bottom:14px;">
      <h2 style="margin-top:0;">Gym Availability (Shared)</h2>
      <p class="sub" style="margin-top:0;">
        Based on anonymous start times from everyone using the app.
      </p>
    
      <div id="gridLegend" class="sub" style="margin-top:10px;">
        <span style="margin-right:12px;">üü© free</span>
        <span style="margin-right:12px;">üü® medium</span>
        <span>üü• busy</span>
      </div>
    
      <div id="hourGrid" style="
        margin-top:12px;
        display:grid;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        gap:10px;
      "></div>
    
      <p id="gridMsg" class="sub" style="margin-top:12px;"></p>
    </section>
    
  </main>

  <footer class="wrap foot">
    <p>Built by TeddyWestSide‚ÄìTagore.</p>
  </footer>
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const startBtn = document.getElementById("startBtn");
      const endBtn = document.getElementById("endBtn");
      const clearBtn = document.getElementById("clearBtn");
      const statusEl = document.getElementById("status");
      const lastSessionEl = document.getElementById("lastSession");
      const debugEl = document.getElementById("debug");
      const hourGrid = document.getElementById("hourGrid");
      const gridMsg = document.getElementById("gridMsg");

  
      function debug(msg) { debugEl.textContent = msg; }
      function pretty(dt) { return new Date(dt).toLocaleString(); }
  
      // Element check
      if (!startBtn || !endBtn || !clearBtn || !statusEl || !lastSessionEl || !debugEl || !hourGrid || !gridMsg) {
  console.error("Missing elements");
  return;
}

  
      // localStorage check
      try {
        localStorage.setItem("__gym_test__", "1");
        localStorage.removeItem("__gym_test__");
      } catch (e) {
        statusEl.textContent = "Status: local storage is blocked in this browser mode.";
        debug("Try normal mode (not private) or allow site storage/cookies.");
        startBtn.disabled = true;
        endBtn.disabled = true;
        clearBtn.disabled = true;
        return;
      }
  
      const API_BASE = "https://gym-api.teddywestside.workers.dev";
      const KEY = "gym_session_current"; // { session_id, startedAt }
  
      function loadCurrent() {
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : null;
      }
      function saveCurrent(obj) { localStorage.setItem(KEY, JSON.stringify(obj)); }
      function clearCurrent() { localStorage.removeItem(KEY); }

      function bucketColor(count) {
  // super simple thresholds for now
  if (count <= 1) return { label: "free", cls: "free" };
  if (count <= 4) return { label: "medium", cls: "med" };
  return { label: "busy", cls: "busy" };
}

async function loadGrid() {
  gridMsg.textContent = "Loading shared data‚Ä¶";
  hourGrid.innerHTML = "";

  try {
    // still fetch last 24h (enough data to fill "today" view)
    const r = await fetch(`${API_BASE}/stats?mode=hour_of_day`);
    const data = await r.json();
    if (!r.ok || !data.ok) throw new Error(data.error || `HTTP ${r.status}`);

    // Map of UTC hour key -> count
    const map = new Map((data.rows || []).map(x => [Number(x.hour), Number(x.starts || 0)]));

// 12 AM -> 11 PM (always same order)
for (let h = 0; h < 24; h++) {
  const count = map.get(h) || 0;
  const b = bucketColor(count);

  const cell = document.createElement("div");
  cell.style.border = "1px solid #2a2f3a";
  cell.style.borderRadius = "12px";
  cell.style.padding = "10px";
  cell.style.background =
    b.cls === "free" ? "rgba(40, 140, 80, 0.18)"
  : b.cls === "med"  ? "rgba(200, 170, 60, 0.18)"
  :                   "rgba(200, 60, 60, 0.18)";

  const label = new Date(2000, 0, 1, h).toLocaleTimeString([], {
    hour: "numeric",
    hour12: true,
  });

  cell.innerHTML = `
    <div style="font-size:12px; color: rgba(233,233,238,0.75);">${label}</div>
    <div style="font-size:18px; font-weight:700; margin-top:4px;">${count}</div>
    <div style="font-size:12px; color: rgba(233,233,238,0.6); margin-top:2px;">${b.label}</div>
  `;
  hourGrid.appendChild(cell);
}

gridMsg.textContent = "Counts = total session starts in that hour (all-time).";


    // Build 24 cells in local-day order: 12 AM -> 11 PM
    const today = new Date();
    const y = today.getFullYear();
    const m = today.getMonth();
    const d0 = today.getDate();

    for (let h = 0; h < 24; h++) {
      // Local "today at hour h"
      const localHour = new Date(y, m, d0, h, 0, 0, 0);

      // Convert that local hour moment to the UTC key your backend uses
      const utcKey =
        localHour.getUTCFullYear() + "-" +
        String(localHour.getUTCMonth() + 1).padStart(2, "0") + "-" +
        String(localHour.getUTCDate()).padStart(2, "0") + "T" +
        String(localHour.getUTCHours()).padStart(2, "0") + ":00Z";

      const count = map.get(utcKey) || 0;
      const b = bucketColor(count);

      const cell = document.createElement("div");
      cell.style.border = "1px solid #2a2f3a";
      cell.style.borderRadius = "12px";
      cell.style.padding = "10px";
      cell.style.background = b.cls === "free" ? "rgba(40, 140, 80, 0.18)"
                        : b.cls === "med"  ? "rgba(200, 170, 60, 0.18)"
                        :                   "rgba(200, 60, 60, 0.18)";

      // label like "12 AM", "1 AM", ...
      const label = localHour.toLocaleTimeString([], { hour: "numeric", hour12: true });

      cell.innerHTML = `
        <div style="font-size:12px; color: rgba(233,233,238,0.75);">${label}</div>
        <div style="font-size:18px; font-weight:700; margin-top:4px;">${count}</div>
        <div style="font-size:12px; color: rgba(233,233,238,0.6); margin-top:2px;">${b.label}</div>
      `;
      hourGrid.appendChild(cell);
    }

    gridMsg.textContent = "Counts = number of sessions started in each hour (today).";
  } catch (e) {
    gridMsg.textContent = `Could not load shared data: ${e.message}`;
  }
}


  
      function render() {
        const current = loadCurrent();
        const active = current?.startedAt && current?.session_id;
  
        if (!active) {
          statusEl.textContent = "Status: not started yet.";
        } else {
          statusEl.textContent = `Status: active (started ${pretty(current.startedAt)})`;
        }
  
        // keep blank for now (we'll show real grid next)
        lastSessionEl.textContent = "";
  
        startBtn.disabled = !!active;
        endBtn.disabled = !active;
  

      }
  
      startBtn.addEventListener("click", async () => {
        startBtn.disabled = true;
        debug("Starting session‚Ä¶");
  
        try {
          const r = await fetch(`${API_BASE}/start`, { method: "POST" });
          const data = await r.json();
  
          if (!r.ok || !data.ok) throw new Error(data.error || `HTTP ${r.status}`);
  
          saveCurrent({ session_id: data.session_id, startedAt: data.started_at });
          debug("Started ‚úÖ");
        } catch (e) {
          debug(`Start failed: ${e.message}`);
        } finally {
          render();
          loadGrid()
        }
      });
  
      endBtn.addEventListener("click", async () => {
        const current = loadCurrent();
        if (!current?.session_id) {
          debug("No active session found.");
          return;
        }
  
        endBtn.disabled = true;
        debug("Ending session‚Ä¶");
  
        try {
          const r = await fetch(`${API_BASE}/end`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_id: current.session_id }),
          });
          const data = await r.json();
  
          if (!r.ok || !data.ok) throw new Error(data.error || `HTTP ${r.status}`);
  
          clearCurrent();
          debug(`Ended ‚úÖ (${data.duration_sec}s)`);
        } catch (e) {
          debug(`End failed: ${e.message}`);
        } finally {
          render();
          loadGrid()        }
      });
  
      clearBtn.addEventListener("click", () => {
  clearCurrent();
  render();
  loadGrid();
});

  
      debug("JS loaded ‚úÖ");
render();
loadGrid();
    });
  </script>  
</body>
</html>
