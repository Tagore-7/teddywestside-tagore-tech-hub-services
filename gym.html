<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gym Availability @ Tech</title>
  <meta name="description" content="Gym availability tracker for students at Michigan Tech." />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="wrap">
    <div class="brand">
      <div class="logo" aria-hidden="true">GY</div>
      <div>
        <h1>Gym Availability @ Tech</h1>
        <p class="sub">Working-first version: start/end session stored on your device.</p>
      </div>
    </div>

    <p style="margin-top:0;">
      <a href="./" style="color: rgba(233,233,238,0.85); text-decoration: none; border: 1px solid #2a2f3a; padding: 8px 12px; border-radius: 999px; display:inline-block;">
        ← Back to hub
      </a>
    </p>
  </header>

  <main class="wrap">
    <section class="card" style="margin-bottom:14px;">
      <h2 style="margin-top:0;">My Gym Session</h2>
      <p class="sub" style="margin-top:0;">
        Saved locally in your browser (your device only). No login, no cloud.
      </p>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <button id="startBtn" type="button" class="btn">Start session</button>
        <button id="endBtn" type="button" class="btn">End session</button>
        <button id="clearBtn" type="button" class="btn btn-ghost">Clear local data</button>
      </div>

      <div class="note" style="margin-top:14px;">
        <p id="status" style="margin:0;">Status: loading…</p>
        <p id="lastSession" style="margin:8px 0 0; color: rgba(233,233,238,0.75);"></p>
        <p id="debug" style="margin:8px 0 0; color: rgba(233,233,238,0.6); font-size: 12px;"></p>
      </div>
    </section>
  </main>

  <footer class="wrap foot">
    <p>Built by TeddyWestSide–Tagore.</p>
  </footer>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const startBtn = document.getElementById("startBtn");
      const endBtn = document.getElementById("endBtn");
      const clearBtn = document.getElementById("clearBtn");
      const statusEl = document.getElementById("status");
      const lastSessionEl = document.getElementById("lastSession");
      const debugEl = document.getElementById("debug");

      function debug(msg) { debugEl.textContent = msg; }

      // If any element is missing, show it clearly.
      if (!startBtn || !endBtn || !clearBtn || !statusEl || !lastSessionEl || !debugEl) {
        debug("ERROR: One or more elements not found. Check IDs in gym.html.");
        return;
      }

      // Check localStorage availability (sometimes blocked in strict modes)
      try {
        localStorage.setItem("__gym_test__", "1");
        localStorage.removeItem("__gym_test__");
      } catch (e) {
        statusEl.textContent = "Status: local storage is blocked in this browser mode.";
        debug("Try normal mode (not private) or allow site storage/cookies.");
        startBtn.disabled = true;
        endBtn.disabled = true;
        clearBtn.disabled = true;
        return;
      }

      const KEY = "gym_session_current";
      const HISTORY_KEY = "gym_session_history";

      function nowISO() { return new Date().toISOString(); }
      function pretty(dt) { return new Date(dt).toLocaleString(); }

      function loadCurrent() {
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : null;
      }
      function saveCurrent(obj) { localStorage.setItem(KEY, JSON.stringify(obj)); }
      function clearCurrent() { localStorage.removeItem(KEY); }

      function loadHistory() {
        const raw = localStorage.getItem(HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      }
      function saveHistory(arr) {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
      }

      function render() {
        const current = loadCurrent();
        const history = loadHistory();

        if (!current) {
          statusEl.textContent = "Status: not started yet.";
        } else if (current.startedAt && !current.endedAt) {
          statusEl.textContent = `Status: active (started ${pretty(current.startedAt)})`;
        } else {
          statusEl.textContent = "Status: not started yet.";
        }

        if (history.length === 0) {
          lastSessionEl.textContent = "";
        } else {
          const last = history[0];
          const mins = Math.max(0, Math.round((new Date(last.endedAt) - new Date(last.startedAt)) / 60000));
          lastSessionEl.textContent =
            `Last session: ${pretty(last.startedAt)} → ${pretty(last.endedAt)} (${mins} min)`;
        }

        const active = current && current.startedAt && !current.endedAt;
        startBtn.disabled = !!active;
        endBtn.disabled = !active;

        debug("JS loaded ✅ (if buttons still do nothing, tell me what this debug line says).");
      }

      startBtn.addEventListener("click", () => {
        saveCurrent({ startedAt: nowISO(), endedAt: null });
        render();
      });

      endBtn.addEventListener("click", () => {
        const current = loadCurrent();
        if (!current || !current.startedAt) return;

        const endedAt = nowISO();
        const history = loadHistory();
        history.unshift({ startedAt: current.startedAt, endedAt });
        saveHistory(history.slice(0, 10));

        clearCurrent();
        render();
      });

      clearBtn.addEventListener("click", () => {
        localStorage.removeItem(KEY);
        localStorage.removeItem(HISTORY_KEY);
        render();
      });

      render();
    });
  </script>
</body>
</html>
